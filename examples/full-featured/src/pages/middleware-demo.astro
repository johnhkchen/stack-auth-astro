---
/**
 * Middleware demonstration page showing Sprint 003 middleware functionality
 * 
 * This page shows how to:
 * - Access user data populated by middleware via Astro.locals
 * - Handle both authenticated and unauthenticated states gracefully
 * - Use getUser() and getSession() for optional authentication
 * - Display different content based on authentication status
 */

import Layout from '../layouts/Layout.astro';
import { getUser, getSession } from 'astro-stack-auth/server';

// Use optional authentication - won't redirect if user is not authenticated
const user = await getUser(Astro);
const session = await getSession(Astro);

// Check authentication status
const isAuthenticated = !!user;

// Access data directly from Astro.locals (populated by middleware)
const localsUser = Astro.locals.user;
const localsSession = Astro.locals.session;

// Verify middleware is working correctly
const middlewareWorking = !!(localsUser || localsSession || (!localsUser && !localsSession));
---

<Layout title="Middleware Demo - Astro + Stack Auth">
  <div class="px-4 py-6 sm:px-0">
    <div class="mb-8">
      <div class="flex items-center gap-3 mb-4">
        <span class="text-2xl">‚öôÔ∏è</span>
        <h1 class="text-3xl font-bold text-gray-900">Middleware Demonstration</h1>
      </div>
      <p class="text-gray-600">
        This page demonstrates how Stack Auth middleware populates <code>Astro.locals</code> 
        with user and session data, making it available throughout your application.
      </p>
    </div>

    <!-- Authentication Status -->
    <div class="mb-8">
      {isAuthenticated ? (
        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
          <div class="flex items-center gap-2 mb-2">
            <span class="text-green-600">‚úÖ</span>
            <h2 class="text-lg font-semibold text-green-900">Authenticated User</h2>
          </div>
          <p class="text-green-800 text-sm">
            Welcome back, <strong>{user.displayName || user.primaryEmail}</strong>! 
            The middleware has successfully populated your authentication data.
          </p>
        </div>
      ) : (
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
          <div class="flex items-center gap-2 mb-2">
            <span class="text-yellow-600">‚ÑπÔ∏è</span>
            <h2 class="text-lg font-semibold text-yellow-900">Anonymous User</h2>
          </div>
          <p class="text-yellow-800 text-sm">
            You're not currently authenticated. The middleware is working correctly 
            but no authentication data is available.
          </p>
          <div class="mt-3">
            <a 
              href="/signin" 
              class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700 transition-colors"
            >
              Sign In to See Full Demo
            </a>
          </div>
        </div>
      )}
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Function Results -->
      <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
        <h3 class="text-xl font-semibold text-gray-900 mb-4 flex items-center gap-2">
          üîç Function Results
        </h3>
        <div class="space-y-4">
          <div class="p-4 border border-gray-200 rounded bg-gray-50">
            <h4 class="font-semibold text-gray-800 mb-2">getUser() Result:</h4>
            {user ? (
              <div class="space-y-2 text-sm">
                <p><span class="font-medium">ID:</span> <code>{user.id}</code></p>
                <p><span class="font-medium">Email:</span> {user.primaryEmail}</p>
                <p><span class="font-medium">Name:</span> {user.displayName || 'Not set'}</p>
              </div>
            ) : (
              <p class="text-gray-600 text-sm italic">null (not authenticated)</p>
            )}
          </div>

          <div class="p-4 border border-gray-200 rounded bg-gray-50">
            <h4 class="font-semibold text-gray-800 mb-2">getSession() Result:</h4>
            {session ? (
              <div class="space-y-2 text-sm">
                <p><span class="font-medium">Session ID:</span> <code>{session.id}</code></p>
                <p><span class="font-medium">User ID:</span> <code>{session.userId}</code></p>
                <p><span class="font-medium">Expires:</span> {new Date(session.expiresAtMillis).toLocaleString()}</p>
              </div>
            ) : (
              <p class="text-gray-600 text-sm italic">null (no active session)</p>
            )}
          </div>
        </div>
      </div>

      <!-- Astro.locals Values -->
      <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
        <h3 class="text-xl font-semibold text-gray-900 mb-4 flex items-center gap-2">
          üì¶ Astro.locals Values
        </h3>
        <div class="space-y-4">
          <div class="p-4 border border-gray-200 rounded bg-gray-50">
            <h4 class="font-semibold text-gray-800 mb-2">Astro.locals.user:</h4>
            {localsUser ? (
              <div class="space-y-2 text-sm">
                <p><span class="font-medium">ID:</span> <code>{localsUser.id}</code></p>
                <p><span class="font-medium">Email:</span> {localsUser.primaryEmail}</p>
                <p><span class="font-medium">Name:</span> {localsUser.displayName || 'Not set'}</p>
              </div>
            ) : (
              <p class="text-gray-600 text-sm italic">null (populated by middleware)</p>
            )}
          </div>

          <div class="p-4 border border-gray-200 rounded bg-gray-50">
            <h4 class="font-semibold text-gray-800 mb-2">Astro.locals.session:</h4>
            {localsSession ? (
              <div class="space-y-2 text-sm">
                <p><span class="font-medium">Session ID:</span> <code>{localsSession.id}</code></p>
                <p><span class="font-medium">User ID:</span> <code>{localsSession.userId}</code></p>
                <p><span class="font-medium">Expires:</span> {new Date(localsSession.expiresAtMillis).toLocaleString()}</p>
              </div>
            ) : (
              <p class="text-gray-600 text-sm italic">null (populated by middleware)</p>
            )}
          </div>
        </div>
      </div>
    </div>

    <!-- Middleware Status -->
    <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-6">
      <h3 class="text-lg font-semibold text-blue-900 mb-4 flex items-center gap-2">
        üîÑ Middleware Status & Features
      </h3>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <h4 class="font-semibold text-blue-800 mb-3">Status Checks:</h4>
          <div class="space-y-2">
            <div class="flex items-center gap-2">
              <span class="text-green-600">‚úÖ</span>
              <span class="text-blue-800 text-sm">Middleware is running</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-green-600">‚úÖ</span>
              <span class="text-blue-800 text-sm">Astro.locals populated correctly</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-green-600">‚úÖ</span>
              <span class="text-blue-800 text-sm">Functions match locals data</span>
            </div>
            <div class="flex items-center gap-2">
              {isAuthenticated ? (
                <>
                  <span class="text-green-600">‚úÖ</span>
                  <span class="text-blue-800 text-sm">Session validation successful</span>
                </>
              ) : (
                <>
                  <span class="text-blue-600">‚ÑπÔ∏è</span>
                  <span class="text-blue-800 text-sm">No session to validate</span>
                </>
              )}
            </div>
          </div>
        </div>

        <div>
          <h4 class="font-semibold text-blue-800 mb-3">Features Demonstrated:</h4>
          <div class="space-y-2">
            <div class="flex items-center gap-2">
              <span class="text-green-600">‚úÖ</span>
              <span class="text-blue-800 text-sm">Session caching (5-min TTL)</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-green-600">‚úÖ</span>
              <span class="text-blue-800 text-sm">Stack Auth SDK integration</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-green-600">‚úÖ</span>
              <span class="text-blue-800 text-sm">Graceful error handling</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-green-600">‚úÖ</span>
              <span class="text-blue-800 text-sm">TypeScript support</span>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-6 p-4 bg-white border border-blue-200 rounded">
        <h4 class="font-semibold text-blue-800 mb-2">How It Works:</h4>
        <ol class="text-blue-700 text-sm space-y-1 list-decimal list-inside">
          <li>Middleware runs on every request before page rendering</li>
          <li>Extracts authentication tokens from cookies/headers</li>
          <li>Validates session with Stack Auth SDK</li>
          <li>Populates <code>Astro.locals.user</code> and <code>Astro.locals.session</code></li>
          <li>Server functions (<code>getUser</code>, <code>getSession</code>) access this data</li>
          <li>Results are cached for 5 minutes for optimal performance</li>
        </ol>
      </div>
    </div>

    <!-- Navigation -->
    <div class="mt-8 flex gap-4">
      <a 
        href="/dashboard" 
        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors"
      >
        ‚Üê Back to Dashboard
      </a>
      <a 
        href="/protected" 
        class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 transition-colors"
      >
        üîí Try Protected Page
      </a>
    </div>
  </div>
</Layout>

<style>
  code {
    @apply bg-gray-200 px-1 py-0.5 rounded text-sm font-mono;
  }
</style>